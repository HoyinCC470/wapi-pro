<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœªæ¹ƒ WAPI Â· AI Cloud Workspace</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script type="module">
        import autoAnimate from 'https://cdn.jsdelivr.net/npm/@formkit/auto-animate/index.min.js';
        window.autoAnimate = autoAnimate;
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* 3. å¢åŠ ã€Œå™ªé»ã€ (Noise) - é‡å°äº®è‰²èƒŒæ™¯å„ªåŒ– */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            /* é»‘è‰²é¡†ç²’å™ªé» svg */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            opacity: 0.6; /* ç¨å¾®å¢åŠ ä¸é€æ˜åº¦ä»¥é€‚åº”æµ…è‰²èƒŒæ™¯ */
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: multiply; 
        }

        /* æ»¾å‹•æ¢æ¨£å¼ (é©é…äº®è‰²) */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        /* === Markdown æ’ç‰ˆ (äº®è‰²æ¨¡å¼é©é…) === */
        .markdown-body { 
            font-size: 1rem; 
            line-height: 1.8; 
            color: #374151;   /* gray-700 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }

        .markdown-body p, .markdown-body ul, .markdown-body ol, .markdown-body blockquote { margin-bottom: 1.25rem; }
        .markdown-body p:last-child { margin-bottom: 0; }

        /* === è¡¨æ ¼ä¼˜åŒ– (ç½‘æ ¼çº¿) === */
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            font-size: 0.9em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #e5e7eb; /* æµ…ç°è‰²ç½‘æ ¼çº¿ */
            padding: 0.75rem;
            text-align: left;
        }
        .markdown-body th {
            background-color: #f9fafb; /* è¡¨å¤´æµ…ç°èƒŒæ™¯ */
            font-weight: 600;
            color: #111827;
        }
        .markdown-body tr:nth-child(even) {
            background-color: #fcfcfc; /* éš”è¡Œå¾®å˜è‰²ï¼Œå¢åŠ å¯è¯»æ€§ */
        }
        

        /* æ¨™é¡Œ (æ·±é»‘) - æƒé‡é™ä½åˆ° 600 */
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            color: #111827; 
            font-weight: 600; /* åŸæ¥æ˜¯ 700ï¼Œæ”¹ç»†ä¸€ç‚¹ */
            margin-top: 2rem; margin-bottom: 1rem; line-height: 1.3;
        }

        /* æ–°å¢ï¼šæ­£æ–‡é‡Œçš„åŠ ç²—æ–‡å­— (**text**) ä¹Ÿæ”¹ç»† */
        .markdown-body strong, .markdown-body b {
            font-weight: 600; /* é»˜è®¤æ˜¯ 700ï¼Œæ”¹æˆ 600 ä¼šæ¸…æ™°å¾ˆå¤š */
            color: #111827;   /* åŠ æ·±é¢œè‰²ï¼Œå¼¥è¡¥å˜ç»†åçš„è§†è§‰é‡é‡ */
        }
        .markdown-body h1 { font-size: 1.5rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5rem; }

        /* ä»£ç å— (ä¿æŒæ·±è‰²ï¼Œä½†ç”±å¤–å±‚å®¹å™¨æ§åˆ¶åœ†è§’) */
        .markdown-body pre { 
            background-color: #1f2937 !important; 
            margin: 0 !important; /* å»æ‰ marginï¼Œäº¤ç»™ wrapper */
            padding: 1rem; 
            overflow-x: auto;
            color: #f3f4f6;
            border: none; /* å»æ‰è¾¹æ¡† */
            border-radius: 0 0 0.5rem 0.5rem; /* åªåœ†ä¸‹è§’ */
        }
        
        /* ä»£ç å—å¤–å±‚å®¹å™¨ (æ–°å¢) */
        .code-block-wrapper {
            margin: 1.5rem 0;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* è¡Œå…§ä»£ç¢¼ (æµ…è‰²èƒŒæ™¯) */
        .markdown-body :not(pre) > code { 
            background-color: #f3f4f6; 
            border: 1px solid #e5e7eb;
            color: #d946ef; 
            padding: 0.2em 0.4em; border-radius: 0.3rem; font-size: 0.85em; font-family: monospace;
        }

        .markdown-body blockquote {
            border-left: 4px solid #3b82f6;
            background-color: #f9fafb; 
            padding: 0.5rem 1rem; color: #4b5563;
            font-style: italic; border-radius: 0 0.5rem 0.5rem 0;
        }

        .markdown-body a { color: #2563eb; text-decoration: underline; text-underline-offset: 4px; }
        .markdown-body a:hover { color: #1d4ed8; }
        .markdown-body hr { border-color: #e5e7eb; margin: 2rem 0; }

        /* åˆ—è¡¨é¸ä¸­æ¨£å¼ (äº®è‰²ç‰ˆ - æ‚¬æµ®èƒ¶å›Šæ„Ÿ) */
        .history-item-active { 
            background-color: #ffffff; 
            color: #111827 !important; 
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: none !important; /* å»æ‰å·¦è¾¹æ¡†ï¼Œæ”¹ç”¨çº¯å‡€å¡ç‰‡é£ */
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        /* éš±è—ä¸æƒ³é¡¯ç¤ºçš„å…ƒç´  */
        .hidden { display: none; }

        /* è¾“å…¥æ¡† Focus æ—¶çš„å…‰æ™• - ç§»é™¤é»˜è®¤ outline */
        textarea:focus, 
        input[type="text"]:focus, 
        input[type="password"]:focus {
            outline: none !important;
        }
        
        /* è¾“å…¥æ¡†å®¹å™¨å…‰æ•ˆ */
        .input-glow:focus-within {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), 
                        0 0 20px rgba(59, 130, 246, 0.1), 
                        0 8px 25px rgba(0,0,0,0.08);
            border-color: rgba(59, 130, 246, 0.3) !important;
        }
        
        /* å•ç‹¬è¾“å…¥æ¡†çš„å…‰æ•ˆï¼ˆè®¤è¯è¾“å…¥æ¡†ï¼‰ */
        input[type="text"]:focus,
        input[type="password"]:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), 
                        0 0 15px rgba(59, 130, 246, 0.1);
        }

        /* === å­—ä½“å¤§å°æ§åˆ¶ (Font Size Control) === */
        /* 1. æ ‡å‡† (é»˜è®¤) - 14px */
        #chat-container.font-size-sm .markdown-body { font-size: 0.9rem; line-height: 1.7; }
        
        /* 2. ä¸­ç­‰ - 16px */
        #chat-container.font-size-base .markdown-body { font-size: 1.05rem; line-height: 1.8; }
        
        /* 3. å¤§å· - 18px */
        #chat-container.font-size-lg .markdown-body { font-size: 1.2rem; line-height: 1.9; }

        /* æŒ‰é’®ç‚¹å‡»æ—¶çš„å¾®åŠ¨ç”» */
        .btn-click-anim:active { transform: scale(0.95); }

    </style>
</head>
<body class="bg-[#F0EEE9] text-gray-800 font-sans h-screen flex overflow-hidden selection:bg-blue-100 selection:text-blue-900">

    <div id="auth-modal" class="fixed inset-0 z-50 bg-white/80 backdrop-blur-sm flex items-center justify-center p-4 transition-all duration-500">
        <div class="bg-white border border-white/50 rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.1)] w-full max-w-md p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-purple-400"></div>
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">WAPI æ™ºèƒ½å·¥ä½œå°</h2>
                <p class="text-gray-500 text-sm">ç™»å½•ä»¥åŒæ­¥æ‚¨çš„åˆ›æ„èµ„äº§</p>
            </div>
            <div class="space-y-4" id="auth-form-container">
                <input type="text" id="auth-username" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-gray-900 focus:border-blue-500 focus:bg-white outline-none transition-all" placeholder="ç”¨æˆ·å" autocomplete="off">
                <input type="password" id="auth-password" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-gray-900 focus:border-blue-500 focus:bg-white outline-none transition-all" placeholder="å¯†ç " autocomplete="off">
                <input type="text" id="auth-registration-code" class="hidden w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-gray-900 focus:border-blue-500 focus:bg-white outline-none transition-all" placeholder="æ³¨å†Œç " autocomplete="off">
                <div id="auth-error" class="hidden text-red-500 text-xs text-center bg-red-50 py-2 rounded border border-red-100"></div>
                <button id="btn-login" class="w-full py-3 bg-gray-900 hover:bg-gray-800 text-white font-bold rounded-lg transition-all shadow-lg shadow-gray-900/20">ç«‹å³ç™»å½•</button>
                <button id="btn-register" class="w-full py-3 bg-transparent border border-gray-200 hover:border-gray-400 text-gray-500 hover:text-gray-700 font-medium rounded-lg transition-all">æ³¨å†Œæ–°è´¦å·</button>
                <button id="btn-back-login" class="hidden w-full py-2 text-sm text-gray-400 hover:text-gray-600 font-medium transition-all">è¿”å›ç™»å½•</button>
            </div>
        </div>
    </div>

<aside class="w-64 min-w-[16rem] bg-white/60 backdrop-blur-xl border-r border-white/40 shadow-sm flex flex-col flex-shrink-0 z-20">
        <div class="p-6 border-b border-gray-200/50 flex items-center">
            <img src="./logo.png" alt="æœªæ¹ƒ WAPI" class="h-19 w-auto object-contain mix-blend-multiply select-none">
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            
            <button onclick="startNewChat(true)" class="group w-full flex items-center justify-center gap-2 px-4 py-3 bg-white hover:bg-blue-50 text-gray-800 font-bold border border-gray-200 hover:border-blue-200 rounded-xl shadow-sm hover:shadow-md transition-all">
                <svg class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span>å‘èµ·æ–°å¯¹è¯</span>
            </button>

            <div>
                <div class="flex items-center mb-3 pl-2 border-l-2 border-green-500">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">æœ€è¿‘å¯¹è¯</h3>
                    </div>
                <div class="space-y-1 min-h-[50px]" id="chat-history-list">
                    <div class="text-xs text-gray-400 italic px-2">åŠ è½½ä¸­...</div>
                </div>
            </div>

        
        </div> 

        <div class="p-4 border-t border-gray-200/50 bg-white/30 backdrop-blur-sm">
            <button onclick="openImageGallery()" class="group w-full flex items-center justify-center gap-2 px-4 py-3 bg-white hover:bg-purple-50 text-gray-700 font-bold border border-gray-200 hover:border-purple-200 rounded-xl shadow-sm hover:shadow-md transition-all">
                <svg class="w-5 h-5 text-purple-500 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <span>æˆ‘çš„ä½œå“åº“</span>
            </button>
        </div>

    </aside> 

    <main class="flex-1 flex flex-col relative min-w-0">
        <header class="h-16 border-b border-gray-200/50 bg-[#F0EEE9]/80 flex items-center px-6 justify-between backdrop-blur-md z-10 sticky top-0">
            <div id="current-workflow-title" class="font-bold text-lg text-gray-800 flex items-center gap-2"></div>
            <div class="flex items-center gap-3">
                <div class="relative group z-50">
                    <button class="flex items-center gap-2 px-4 py-2 bg-white/50 border border-gray-200 rounded-xl text-xs font-bold text-gray-600 shadow-sm transition-all hover:bg-white hover:text-gray-900 hover:shadow-md">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                        <span>å­—ä½“å¤§å°</span>
                    </button>

                    <div class="absolute top-full right-0 mt-2 w-24 bg-white border border-gray-200 rounded-xl shadow-xl overflow-hidden transition-all duration-300 opacity-0 invisible transform translate-y-2 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 flex flex-col p-1">
                        
                        <div onclick="setFontSize(0)" class="cursor-pointer px-3 py-2 rounded-lg text-xs text-center text-gray-500 hover:text-gray-900 hover:bg-gray-100 transition-colors">
                            å°
                        </div>
                        
                        <div onclick="setFontSize(1)" class="cursor-pointer px-3 py-2 rounded-lg text-xs text-center text-gray-500 hover:text-gray-900 hover:bg-gray-100 transition-colors">
                            ä¸­
                        </div>
                        
                        <div onclick="setFontSize(2)" class="cursor-pointer px-3 py-2 rounded-lg text-xs text-center text-gray-500 hover:text-gray-900 hover:bg-gray-100 transition-colors">
                            å¤§
                        </div>
                    </div>
                </div>
                <div class="relative group z-50">
                    <div class="cursor-pointer flex items-center gap-2 text-xs font-bold text-gray-700 bg-white/50 px-4 py-2 rounded-xl border border-gray-200 shadow-sm select-none transition-all hover:bg-white hover:shadow-md">
                        <span id="header-username">æœªç™»å½•</span>
                        <svg class="w-3 h-3 text-gray-400 group-hover:rotate-180 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>

                    <div class="absolute top-full right-0 mt-2 w-32 bg-white border border-gray-200 rounded-xl shadow-xl overflow-hidden transition-all duration-300 opacity-0 invisible transform translate-y-2 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 flex flex-col p-1">
                        <button onclick="logout()" class="flex items-center justify-center gap-2 px-3 py-2.5 rounded-lg text-xs font-bold text-red-500 hover:bg-red-50 transition-colors w-full">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            é€€å‡ºç™»å½•
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div id="text-workflow" class="flex-1 flex flex-col overflow-hidden hidden">
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 scroll-smooth"></div>
            
            <div class="p-6 border-t border-gray-200/50 bg-[#F0EEE9]/50 z-20 backdrop-blur-sm">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white border border-gray-200 shadow-[0_4px_20px_rgba(0,0,0,0.03)] rounded-2xl overflow-visible transition-shadow duration-300 focus-within:shadow-md focus-within:border-blue-300 group relative input-glow">
                        
                        <textarea id="chat-input" rows="1" class="w-full block bg-transparent border-none px-5 py-4 text-gray-800 placeholder-gray-400 focus:ring-0 resize-none overflow-hidden leading-relaxed max-h-[200px]" placeholder="Enter æ¢è¡Œï¼ŒCtrl + Enter å‘é€..." oninput="autoResizeTextarea(this)"></textarea>

                        <div class="flex justify-between items-center px-3 pb-3 pt-1 border-t border-gray-50/50">
                            
                            <div class="flex items-center gap-2">
                                <input type="file" id="file-upload" accept=".doc,.docx,.txt,.pdf" class="hidden" onchange="handleFileUpload(this)">
                                <button onclick="document.getElementById('file-upload').click()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors group" title="ä¸Šä¼ æ–‡æ¡£">
                                    <svg class="w-5 h-5 text-gray-500 group-hover:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                </button>
                                <div id="uploaded-file-info" class="hidden px-3 py-1 bg-blue-50 text-blue-700 text-xs font-medium rounded-lg border border-blue-200">
                                    <span id="upload-status-text"></span>
                                </div>
                                <div class="relative">
                                    <button onclick="toggleModelMenu(event)" class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-100 text-xs font-bold text-gray-600 transition-colors group/btn" title="åˆ‡æ¢æ¨¡å‹">
                                        <div class="w-5 h-5 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-white text-[10px] shadow-sm">M</div>
                                        <span id="current-model-name" class="truncate max-w-[100px]">DeepSeek V3.2</span>
                                        <svg class="w-3 h-3 text-gray-400 group-hover/btn:text-gray-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>

                                    <div id="model-dropdown" class="absolute bottom-full left-0 mb-2 w-64 bg-white border border-gray-200 rounded-xl shadow-xl overflow-hidden transition-all duration-200 opacity-0 invisible transform translate-y-2 flex flex-col p-1 z-50">
                                        <div id="model-list-container" class="max-h-[300px] overflow-y-auto">
                                            </div>
                                    </div>
                                </div>

                                <!-- è§†è§‰æ¨¡å‹æ—¶æ˜¾ç¤ºçš„é€‰é¡¹ -->
                                <div id="image-options" class="hidden flex items-center gap-2">
                                    <div class="relative">
                                        <select id="aspect-ratio-select" class="px-3 py-1.5 text-xs font-medium bg-gray-50 border border-gray-200 rounded-lg outline-none appearance-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100 cursor-pointer">
                                        </select>
                                    </div>
                                    <div class="relative">
                                        <select id="resolution-select" class="px-3 py-1.5 text-xs font-medium bg-gray-50 border border-gray-200 rounded-lg outline-none appearance-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100 cursor-pointer">
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center gap-3">
                                <button id="send-btn" class="p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg shadow-md hover:shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                                </button>
                            </div>

                        </div>
                    </div>
                    <div class="text-center mt-2 flex justify-center gap-4">
                         <p class="text-[10px] text-gray-400">AI å†…å®¹ç”±å¤§æ¨¡å‹ç”Ÿæˆï¼Œè¯·ä»”ç»†ç”„åˆ«ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

<div id="gallery-modal" class="hidden fixed inset-0 z-50 bg-white/90 flex items-center justify-center p-4 backdrop-blur-md transition-all">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-2xl w-full max-w-5xl max-h-[85vh] flex flex-col relative overflow-hidden">
        
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-white z-10 shrink-0 gap-4">
            <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4 overflow-hidden">
                <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2 shrink-0">
                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    æˆ‘çš„åˆ›æ„èµ„äº§
                </h2>
                <div class="flex items-center gap-1.5 px-3 py-1 rounded-full bg-yellow-50 border border-yellow-200 text-yellow-700 text-xs truncate">
                    <svg class="w-3.5 h-3.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <span>æ³¨æ„: å›¾ç‰‡é“¾æ¥æœ‰æ•ˆæœŸçº¦24å°æ—¶, è¯·åŠæ—¶ä¿å­˜, è¿‡æœŸæ— æ³•æ‰¾å›ã€‚</span>
                </div>
            </div>

            <button onclick="document.getElementById('gallery-modal').classList.add('hidden'); document.body.style.overflow = '';" class="text-gray-400 hover:text-gray-900 transition-colors shrink-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div id="gallery-grid" class="flex-1 overflow-y-auto min-h-0 p-2 grid grid-cols-[repeat(auto-fill,minmax(120px,1fr))] gap-1 content-start select-none bg-gray-50">
        </div>

        <div id="gallery-empty" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none">
            <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <p class="text-sm">æš‚æ— ç”Ÿæˆè®°å½•ï¼Œå¿«å»åˆ›ä½œå§ï¼</p>
        </div>
    </div>
</div>

<div id="detail-modal" class="hidden fixed inset-0 z-[60] bg-white/95 backdrop-blur-md flex items-center justify-center opacity-0 transition-opacity duration-300">
    <button onclick="closeDetailModal()" class="absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-full transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>

    <div class="w-full h-full flex flex-col md:flex-row overflow-hidden">
        
        <div class="flex-1 flex items-center justify-center p-4 md:p-10 relative bg-gray-50" onclick="closeDetailModal()">
            <img id="detail-img" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded-lg transition-transform duration-300">
        </div>

        <div class="w-full md:w-96 bg-white border-l border-gray-200 flex flex-col h-full shrink-0" onclick="event.stopPropagation()"> <div class="p-6 border-b border-gray-100">
                <h3 class="text-lg font-bold text-gray-900 mb-1">ä½œå“è¯¦æƒ…</h3>
                <p id="detail-date" class="text-xs text-gray-500">2024/01/01</p>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-2">æç¤ºè¯ (Prompt)</label>
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <p id="detail-prompt" class="text-sm text-gray-700 leading-relaxed break-words font-mono select-text"></p>
                    </div>
                    <button onclick="copyPrompt()" class="mt-2 text-xs text-blue-600 hover:text-blue-500 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                        å¤åˆ¶æç¤ºè¯
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1">åˆ†è¾¨ç‡</label>
                        <p id="detail-res" class="text-sm text-gray-700 font-mono bg-gray-100 px-2 py-1 rounded inline-block">1024x1024</p>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1">æ¨¡å‹</label>
                        <p id="detail-model" class="text-sm text-gray-700 truncate" title="">-</p>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1">é£æ ¼</label>
                        <p id="detail-style" class="text-sm text-gray-700 capitalize">-</p>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-gray-100 bg-white z-10">
                <a id="detail-download" href="#" target="_blank" class="w-full flex items-center justify-center gap-2 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-all shadow-lg shadow-blue-500/20">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ä¸‹è½½åŸå›¾ / æ‰“å¼€é“¾æ¥
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // === è‡ªå®šä¹‰ Markdown æ¸²æŸ“å™¨ (æ”¯æŒä»£ç å¤åˆ¶ & è¯­è¨€æ˜¾ç¤º) ===
    const renderer = new marked.Renderer();
    
    renderer.code = function(code, language) {
        // 1. é«˜äº®å¤„ç†
        const validLang = !!(language && hljs.getLanguage(language));
        const highlighted = validLang ? hljs.highlight(code, { language }).value : hljs.highlightAuto(code).value;
        const langLabel = language ? language : 'Text';

        // 2. å¯¹ä»£ç å†…å®¹è¿›è¡Œ URL ç¼–ç ï¼Œå­˜å…¥ hidden å±æ€§ä¸­ï¼Œæ–¹ä¾¿å¤åˆ¶æ—¶æå–åŸå§‹å†…å®¹
        const rawCode = encodeURIComponent(code);

        // 3. è¿”å›æ„å»ºå¥½çš„ HTML ç»“æ„ (Header + Pre)
        return `
        <div class="code-block-wrapper group">
            <div class="flex items-center justify-between px-4 py-2 bg-gray-100 border-b border-gray-200">
                <span class="text-xs font-bold text-gray-500 uppercase font-mono">${langLabel}</span>
                <button onclick="copyCode(this)" data-code="${rawCode}" class="text-xs text-gray-500 hover:text-blue-600 flex items-center gap-1 transition-colors focus:outline-none">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    <span>å¤åˆ¶</span>
                </button>
            </div>
            <pre><code class="hljs ${language}">${highlighted}</code></pre>
        </div>
        `;
    };

    // åº”ç”¨ table çš„é»˜è®¤æ ·å¼
    renderer.table = function(header, body) {
        return `<div class="overflow-x-auto"><table class="w-full border-collapse my-4">${header}${body}</table></div>`;
    };

    marked.use({ renderer, breaks: true, gfm: true });

    // === å¤åˆ¶ä»£ç åŠŸèƒ½çš„å®ç° ===
    function copyCode(btn) {
        // ä» data-code å±æ€§ä¸­å–å‡ºåŸå§‹å†…å®¹å¹¶è§£ç 
        const rawCode = decodeURIComponent(btn.getAttribute('data-code'));
        
        navigator.clipboard.writeText(rawCode).then(() => {
            // å¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<svg class="w-3.5 h-3.5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span class="text-green-600 font-bold">å·²å¤åˆ¶</span>`;
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
            }, 2000);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
        });
    }

// === 1. é…ç½®ä¸­å¿ƒ ===
    const API_BASE = "/api/ai"; 
    const BACKEND_URL = "/api"; 
    const API_KEY = "";

    // === 2. çŠ¶æ€ç®¡ç† ===
    let state = {
        workflow: 'text',
        textModelKey: "DeepSeek V3.2",
        imageModelKey: "Kwai Kolors",
        chatHistoryId: null,
        messages: []
    };
    
    let isChatProcessing = false;
    let authToken = localStorage.getItem('wapi_token');
    
    // === æ–°å¢ï¼šç”¨äºä¸­æ–­è¯·æ±‚çš„æ§åˆ¶å™¨ ===
    let abortController = null;
    let processingWorkflow = null;
    let imageGenerationContext = null;
    let textGenerationContext = null;

    // === åˆ‡æ¢ å‘é€/åœæ­¢ æŒ‰é’®æ ·å¼ (ä¿®å¤æ‚¬åœé¢œè‰²) ===
    function updateInputUI(isGenerating) {
        const btn = document.getElementById('send-btn');
        const input = document.getElementById('chat-input');
        
        if (isGenerating) {
            // === ğŸ›‘ åœæ­¢çŠ¶æ€ ===
            // 1. æ¸…é™¤æ—§çš„è“è‰²æ ·å¼
            btn.classList.remove('text-blue-500', 'hover:bg-blue-500');
            
            // 2. æ·»åŠ æ–°çš„çº¢è‰²æ ·å¼ (å¹³æ—¶çº¢å­—ï¼Œæ‚¬åœçº¢åº•ç™½å­—)
            btn.classList.add('text-red-500', 'hover:bg-red-500', 'hover:text-white');
            
            // 3. æ¢æˆåœæ­¢å›¾æ ‡ (SVG å†…éƒ¨å»æ‰ text-red-500ï¼Œç”±çˆ¶çº§æ§åˆ¶é¢œè‰²)
            btn.innerHTML = `<svg class="w-5 h-5 animate-pulse" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></svg>`;
            btn.title = "åœæ­¢ç”Ÿæˆ";
            
            // 4. é”å®šè¾“å…¥æ¡†
            input.disabled = true;
            input.placeholder = "AI æ­£åœ¨æ€è€ƒä¸­ (ç‚¹å‡»å³ä¾§æŒ‰é’®åœæ­¢)...";
            input.classList.add('bg-gray-50'); 
        } else {
            // === ğŸš€ å‘é€çŠ¶æ€ ===
            // 1. æ¸…é™¤çº¢è‰²æ ·å¼
            btn.classList.remove('text-red-500', 'hover:bg-red-500');
            
            // 2. æ¢å¤è“è‰²æ ·å¼
            btn.classList.add('text-blue-500', 'hover:bg-blue-500', 'hover:text-white');

            // 3. æ¢æˆå‘é€å›¾æ ‡
            btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>`;
            btn.title = "å‘é€æ¶ˆæ¯";
            
            // 4. è§£é”è¾“å…¥æ¡†
            input.disabled = false;
            input.placeholder = "Enter æ¢è¡Œï¼ŒCtrl + Enter å‘é€...";
            input.classList.remove('bg-gray-50');
            input.focus();
        }
    }

    function determineWorkflowFromMessages(messages = []) {
        if (!Array.isArray(messages) || messages.length === 0) return 'text';
        const lastAssistantMessage = [...messages].reverse().find(msg => msg.role === 'assistant');
        if (!lastAssistantMessage) return 'text';
        const content = (lastAssistantMessage.content || '').trim();
        if (!content) return 'text';
        const normalized = content.split('?')[0] || '';
        const isUrl = /^https?:\/\//i.test(content);
        const hasImageExt = /\.(png|jpe?g|gif|webp|bmp)$/i.test(normalized);
        return (isUrl || hasImageExt) ? 'image' : 'text';
    }

    function detachProcessingForChatSwitch(nextChatId) {
        if (!isChatProcessing) return;
        const isImageJob = processingWorkflow === 'image';
        const isTextJob = processingWorkflow === 'text';
        if (isImageJob && imageGenerationContext) {
            if (imageGenerationContext.chatId === nextChatId) {
                return;
            }
            imageGenerationContext.isBackground = true;
            isChatProcessing = false;
            processingWorkflow = null;
            abortController = null;
            updateInputUI(false);
            return;
        }
        if (isTextJob && textGenerationContext) {
            if (textGenerationContext.chatId === nextChatId) {
                return;
            }
            textGenerationContext.isBackground = true;
            isChatProcessing = false;
            processingWorkflow = null;
            abortController = null;
            updateInputUI(false);
            return;
        }
        if (abortController) {
            abortController.abort();
            abortController = null;
        }
        isChatProcessing = false;
        processingWorkflow = null;
        updateInputUI(false);
        if (isImageJob) {
            imageGenerationContext = null;
        }
        if (isTextJob) {
            textGenerationContext = null;
        }
    }

    function restoreImageJobIfNeeded(chatId) {
        if (!imageGenerationContext || imageGenerationContext.chatId !== chatId || !imageGenerationContext.isBackground) {
            return;
        }
        isChatProcessing = true;
        processingWorkflow = 'image';
        abortController = imageGenerationContext.controller;
        imageGenerationContext.isBackground = false;
        updateInputUI(true);
    }

    function restoreTextJobIfNeeded(chatId) {
        if (!textGenerationContext || textGenerationContext.chatId !== chatId || !textGenerationContext.isBackground) {
            return;
        }
        if (isChatProcessing && processingWorkflow !== 'text') {
            return;
        }
        isChatProcessing = true;
        processingWorkflow = 'text';
        abortController = textGenerationContext.controller;
        textGenerationContext.isBackground = false;
        updateInputUI(true);
        renderChatHistory();
    }
    
    const TEXT_MODELS_MAP = { 
        "DeepSeek V3.2": "deepseek-ai/DeepSeek-V3.2", 
        "Qwen3 32B": "Qwen/Qwen3-32B", 
        "Qwen Coder 480B": "Qwen/Qwen3-coder-480b-a35b-instruct" 
    };
    const IMAGE_MODELS_MAP = { 
        "Kwai Kolors": "Kwai-Kolors/Kolors", 
        "Qwen Image": "Qwen/Qwen-Image", 
        "Tongyi Turbo": "Tongyi-MAI/Z-Image-Turbo" 
    };

    // === æœªæ¹ƒ WAPI ä¸“å±ç³»ç»Ÿäººè®¾ ===
    const SYSTEM_PROMPT = `
    ä½ ç°åœ¨æ˜¯ã€æœªæ¹ƒ WAPIã€‘çš„ä¸“å±æ™ºèƒ½å¯¼å¸ˆå¼•æ“ã€‚
    ä½ çš„æ ¸å¿ƒèŒè´£æ˜¯æœåŠ¡ 10-18 å²çš„ä¸­å›½å¤§é™†å­¦ç”Ÿï¼Œå¼•å¯¼ä»–ä»¬åœ¨â€œè‹±æ–‡æ¼”è®²â€å’Œâ€œAI ç”µå½±åˆ›ä½œâ€é¢†åŸŸæ¢ç´¢ã€‚

    ### ä½ çš„èº«ä»½ä¸æ€§æ ¼
    1.  **å“ç‰Œèº«ä»½**ï¼šä½ æ˜¯æœªæ¹ƒ WAPI çš„ AI åŠ©æ•™ï¼Œåå­—å«â€œå°æ¹ƒâ€œã€‚
    2.  **æ€§æ ¼åŸºè°ƒ**ï¼šé¼“åŠ±å‹ã€å¯å‘å¼ã€ä¸“ä¸šä½†å¹½é»˜ã€å¯Œæœ‰æå®¢ç²¾ç¥ã€‚åƒä¸€ä½å¾ˆé…·çš„å­¦é•¿/å­¦å§ã€‚
    3.  **æ²Ÿé€šå¯¹è±¡**ï¼š10-18 å²é’å°‘å¹´ã€‚è¯·ä½¿ç”¨ç”ŸåŠ¨ã€æ˜“æ‡‚ã€æœ‰æ„ŸæŸ“åŠ›çš„è¯­è¨€ï¼Œé¿å…æ¯ç‡¥çš„è¯´æ•™ã€‚

    ### ä½ çš„ä¸¤å¤§æ ¸å¿ƒä¸šåŠ¡çŸ¥è¯†åº“
    1.  **æœªæ¹ƒ WAPI è‹±æ–‡æ¼”è®²æ´»åŠ¨**ï¼š
        * **æŒ‡å¯¼é‡ç‚¹**ï¼šå…³æ³¨é€»è¾‘ç»“æ„ï¼ˆOpening/Body/Conclusionï¼‰ã€æ‰¹åˆ¤æ€§æ€ç»´ã€å…¬ä¼—æ¼”è®²è‡ªä¿¡å¿ƒã€å‘éŸ³è¯­è°ƒã€‚
        * **é£æ ¼**ï¼šé¼“åŠ±å­¦ç”Ÿç”¨è‹±è¯­è®²å¥½ä¸­å›½æ•…äº‹ï¼Œå…·å¤‡å›½é™…è§†é‡ã€‚
        * **äº’åŠ¨**ï¼šå¦‚æœå­¦ç”Ÿå‘æ¥æ¼”è®²ç¨¿ï¼Œè¯·ä»â€œç»“æ„æ¸…æ™°åº¦â€ã€â€œè¯­è¨€æ„ŸæŸ“åŠ›â€å’Œâ€œè§‚ç‚¹æ·±åº¦â€ä¸‰ä¸ªç»´åº¦ç‚¹è¯„ã€‚

    2.  **æœªæ¹ƒ WAPIÂ·AI ç”µå½±è¯¾ç¨‹**ï¼š
        * **æŒ‡å¯¼é‡ç‚¹**ï¼šAIGC å·¥å…·åº”ç”¨ï¼ˆMJ/SD/Runwayï¼‰ã€åˆ†é•œè®¾è®¡ã€å‰§æœ¬åˆ›æ„ã€è§†è§‰ç¾å­¦ã€‚
        * **é£æ ¼**ï¼šå¼ºè°ƒâ€œç§‘æŠ€+è‰ºæœ¯â€çš„ç»“åˆï¼Œé¼“åŠ±å¤©é©¬è¡Œç©ºçš„æƒ³è±¡åŠ›ã€‚
        * **äº’åŠ¨**ï¼šå¼•å¯¼å­¦ç”Ÿå†™å‡ºæ›´å¥½çš„ Promptï¼ˆæç¤ºè¯ï¼‰ï¼Œå¸®åŠ©ä»–ä»¬æŠŠè„‘æµ·ä¸­çš„ç”»é¢è½¬åŒ–ä¸ºæ–‡å­—æè¿°ã€‚

    ### å›å¤åŸåˆ™
    1.  **å¼•å¯¼ä¼˜äºç›´æ¥ç»™ç­”æ¡ˆ**ï¼šå½“å­¦ç”Ÿé—®â€œå¸®æˆ‘å†™ä¸ªæ¼”è®²ç¨¿â€æ—¶ï¼Œå…ˆé—®ä»–çš„ä¸»é¢˜æƒ³æ³•ï¼Œå¼•å¯¼ä»–æ„å»ºå¤§çº²ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”©å‡ºä¸€ç¯‡æ–‡ç« ã€‚
    2.  **æ­£å‘åé¦ˆ**ï¼šæ— è®ºå­¦ç”Ÿåšå¾—å¦‚ä½•ï¼Œå…ˆè‚¯å®šä»–ä»¬çš„å°è¯•ï¼Œå†ç»™å‡ºæ”¹è¿›å»ºè®®ï¼ˆä¸‰æ˜æ²»æ²Ÿé€šæ³•ï¼‰ã€‚
    3.  **å®‰å…¨åº•çº¿**ï¼šä¸¥æ ¼è¿‡æ»¤ä»»ä½•ä¸é€‚åˆæœªæˆå¹´äººçš„å†…å®¹ï¼ˆæš´åŠ›ã€è‰²æƒ…ã€è¿‡åº¦æ¶ˆæï¼‰ã€‚
    4.  **æ ¼å¼ç¾è§‚**ï¼šå¤šä½¿ç”¨ Markdown æ ¼å¼ï¼ˆåˆ—è¡¨ã€åŠ ç²—ï¼‰è®©é˜…è¯»ä½“éªŒæ›´æ£’ã€‚

    ### åœºæ™¯ç¤ºä¾‹
    * ç”¨æˆ·é—®ï¼šâ€œæˆ‘ä¸æ•¢ä¸Šå°æ¼”è®²ã€‚â€ -> ä½ è¦ç”¨æœªæ¹ƒçš„ä»·å€¼è§‚é¼“åŠ±ä»–ï¼Œåˆ†äº«å…‹æœç´§å¼ çš„å°æŠ€å·§ã€‚
    * ç”¨æˆ·é—®ï¼šâ€œç”»ä¸€åªçŒ«ã€‚â€ -> ä½ è¦å¼•å¯¼ä»–ï¼šâ€œä½ æƒ³ç”»ä¸€åªä»€ä¹ˆæ ·çš„çŒ«ï¼Ÿæ˜¯èµ›åšæœ‹å…‹é£æ ¼çš„æœºæ¢°çŒ«ï¼Œè¿˜æ˜¯å®«å´éªé£æ ¼çš„é­”æ³•çŒ«ï¼Ÿè®©æˆ‘ä»¬ä¸€èµ·æŠŠ Prompt å†™å¾—æ›´å…·ä½“ã€‚â€
    `;
    const ASPECT_RATIOS = { 
        "1:1": ["1024x1024", "768x768"], 
        "3:4": ["864x1152", "768x1024"], 
        "4:3": ["1152x864", "1024x768"], 
        "9:16": ["1080x1920", "720x1280"],
        "16:9": ["1920x1080", "1280x720"] 
    };

    // === å­—ä½“ç®¡ç† ===
    const FONT_SIZES = ['font-size-sm', 'font-size-base', 'font-size-lg'];
    let currentFontIndex = parseInt(localStorage.getItem('wapi_font_index')) || 0;

    // (æ–°ç‰ˆ) ç›´æ¥è®¾ç½®æŒ‡å®šå¤§å° (0:å°, 1:ä¸­, 2:å¤§)
    function setFontSize(index) {
        const container = document.getElementById('chat-container');
        if(!container) return;

        // 1. ç§»é™¤æ‰€æœ‰å­—ä½“ç±»
        FONT_SIZES.forEach(cls => container.classList.remove(cls));
        
        // 2. æ·»åŠ ç›®æ ‡å­—ä½“ç±»
        container.classList.add(FONT_SIZES[index]);
        
        // 3. æ›´æ–°çŠ¶æ€å¹¶ä¿å­˜
        currentFontIndex = index;
        localStorage.setItem('wapi_font_index', index);
        
        // 4. æ§åˆ¶å°è°ƒè¯•
        console.log("Font set to:", FONT_SIZES[index]);
    }

    // åˆå§‹åŒ–å­—ä½“ (éœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨)
    function applySavedFontSize() {
        const container = document.getElementById('chat-container');
        if(container) {
            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„é»˜è®¤ç±»
            FONT_SIZES.forEach(c => container.classList.remove(c));
            // åº”ç”¨ä¿å­˜çš„ç±»
            container.classList.add(FONT_SIZES[currentFontIndex]);
        }
    }

    // === 3. åˆå§‹åŒ– ===
    function init() {
        // ... (ä¿ç•™åŸæ¥çš„ä»£ç )
        // renderSidebar(); // âŒ è¿™è¡Œå¯ä»¥åˆ æ‰æˆ–è€…ç•™ç€ä¹Ÿæ²¡äº‹(å› ä¸ºsidebaré‡Œæ²¡åˆ—è¡¨äº†)
        renderRatioOptions();
        checkLoginState();
        updateWorkflowUI();

        // ğŸ†• åˆå§‹åŒ–è¾“å…¥æ¡†é‡Œçš„æ¨¡å‹å
        const nameEl = document.getElementById('current-model-name');
        if(nameEl) nameEl.innerText = state.workflow === 'text' ? state.textModelKey : state.imageModelKey;

        // ... (ä¿ç•™ autoAnimate ä»£ç )
    }

    // === 4. UI é€»è¾‘ ===
    window.switchModel = (type, key) => {
        state.workflow = type;
        if (type === 'text') state.textModelKey = key;
        if (type === 'image') state.imageModelKey = key;
        renderSidebar();
        updateWorkflowUI();
    };

    function updateWorkflowUI() {
        const textFlow = document.getElementById('text-workflow');
        const title = document.getElementById('current-workflow-title');
        const imageOptions = document.getElementById('image-options');

        // å§‹ç»ˆæ˜¾ç¤ºæ–‡æœ¬å·¥ä½œæµ
        textFlow.classList.remove('hidden');

        if (state.workflow === 'text') {
            title.innerHTML = `æ™ºèƒ½å¯¹è¯ <span class="text-gray-400 text-sm font-normal ml-2">/ ${state.textModelKey}</span>`;
            // éšè—å›¾åƒé€‰é¡¹
            if(imageOptions) imageOptions.classList.add('hidden');
            // æ›´æ–°æ¨¡å‹åç§°æ˜¾ç¤º
            const nameEl = document.getElementById('current-model-name');
            if(nameEl) nameEl.innerText = state.textModelKey;
            // æ›´æ–°è¾“å…¥æ¡†æç¤º
            const input = document.getElementById('chat-input');
            if(input) input.placeholder = "Enter æ¢è¡Œï¼ŒCtrl + Enter å‘é€...";
        
        } else {
            title.innerHTML = `è§†è§‰ç”Ÿæˆ <span class="text-gray-400 text-sm font-normal ml-2">/ ${state.imageModelKey}</span>`;
            // æ˜¾ç¤ºå›¾åƒé€‰é¡¹
            if(imageOptions) imageOptions.classList.remove('hidden');
            // æ›´æ–°æ¨¡å‹åç§°æ˜¾ç¤º
            const nameEl = document.getElementById('current-model-name');
            if(nameEl) nameEl.innerText = state.imageModelKey;
            // æ›´æ–°è¾“å…¥æ¡†æç¤º
            const input = document.getElementById('chat-input');
            if(input) input.placeholder = "è¾“å…¥ç”»é¢æè¿° (æç¤ºè¯)ï¼ŒEnter æ¢è¡Œï¼ŒCtrl + Enter ç”Ÿæˆ...";
        }
    }

    // === 5. æ ¸å¿ƒï¼šæ•°æ®äº¤äº’ ===
    async function loadChatList() {
        if (!authToken) return;
        try {
            const res = await fetch(`${BACKEND_URL}/chat/list`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (res.status === 401) { logout(); return; } 
            const result = await res.json();
            const chats = result.data || [];
            
            const listEl = document.getElementById('chat-history-list');
            
            if (!chats || chats.length === 0) {
                listEl.innerHTML = '<div class="text-xs text-gray-400 italic px-2">æš‚æ— å†å²è®°å½•</div>';
                return;
            }

            // ä¿®æ”¹ï¼šå°† text-xs æ”¹ä¸º text-sm (æ”¾å¤§å­—ä½“)ï¼Œå¹¶ä¿ç•™æ‚¬åœåˆ é™¤åŠŸèƒ½
            listEl.innerHTML = chats.map(chat => `
                <div onclick="loadChatDetail('${chat._id}')" class="group relative flex items-center justify-between cursor-pointer px-3 py-2 rounded text-sm text-gray-600 hover:bg-white hover:text-gray-900 transition-colors ${state.chatHistoryId === chat._id ? 'history-item-active' : ''}">
                    <span class="truncate pr-2 select-none">${chat.title}</span>
                    
                    <button onclick="deleteChat(event, '${chat._id}')" class="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-500 transition-all flex-shrink-0" title="åˆ é™¤æ­¤å¯¹è¯">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `).join('');

            if (!state.chatHistoryId && chats.length > 0 && state.messages.length === 0) {
                loadChatDetail(chats[0]._id);
            }
        } catch (err) {
            console.error("åˆ—è¡¨åŠ è½½å¤±è´¥:", err);
        }
    }

    async function loadChatDetail(chatId) {
        detachProcessingForChatSwitch(chatId);
        
        state.chatHistoryId = chatId;
        const items = document.querySelectorAll('#chat-history-list > div');
        items.forEach(el => {
            if(el.getAttribute('onclick').includes(chatId)) {
                el.classList.add('history-item-active');
            } else {
                el.classList.remove('history-item-active');
            }
        });

        try {
            const res = await fetch(`${BACKEND_URL}/chat/${chatId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const result = await res.json();
            const chat = result.data || {};
            const incomingMessages = chat.messages || [];
            const hasPendingTextJob = textGenerationContext && textGenerationContext.chatId === chatId && textGenerationContext.messagesRef;
            state.messages = hasPendingTextJob ? textGenerationContext.messagesRef : incomingMessages;
            
            const hasPendingImageJob = imageGenerationContext && imageGenerationContext.chatId === chatId;
            const detectedWorkflow = hasPendingImageJob ? 'image' : determineWorkflowFromMessages(state.messages);
            if (state.workflow !== detectedWorkflow) {
                state.workflow = detectedWorkflow;
            }
            updateWorkflowUI();
            
            renderChatHistory();
            restoreImageJobIfNeeded(chatId);
            restoreTextJobIfNeeded(chatId);
        } catch (err) { console.error(err); }
    }

    function startNewChat(clearUI = true) {
        detachProcessingForChatSwitch(null);
        
        state.chatHistoryId = null;
        state.messages = [];
        if (clearUI) {
            renderChatHistory();
            const items = document.querySelectorAll('#chat-history-list > div');
            items.forEach(el => el.classList.remove('history-item-active'));
        }
    }

    async function saveMessageToBackend(role, content, targetChatId = null) {
        if (!authToken) return null;
        let chatId = targetChatId || state.chatHistoryId;
        if (!chatId) {
            try {
                const res = await fetch(`${BACKEND_URL}/chat/new`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ firstMessage: content })
                });
                if (!res.ok) throw new Error("åˆ›å»ºä¼šè¯å¤±è´¥");
                const result = await res.json();
                const newChat = result.data || {};
                chatId = newChat._id;
                if (!targetChatId) {
                    state.chatHistoryId = newChat._id; 
                }
                await loadChatList(); 
            } catch (e) {
                console.error("åˆ›å»ºä¼šè¯æŠ¥é”™:", e);
                return null;
            }
        }
        try {
            await fetch(`${BACKEND_URL}/chat/${chatId}/message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ role, content })
            });
            if (role === 'user') loadChatList(); 
        } catch (e) { console.error("ä¿å­˜æ¶ˆæ¯æŠ¥é”™:", e); }
        return chatId;
    }

    async function generateSmartTitle(chatId, conversation) {
        let finalTitle = "æ–°å¯¹è¯";
        try {
            const firstUserMsg = conversation.find(m => m.role === 'user');
            if (firstUserMsg && firstUserMsg.content) {
                finalTitle = firstUserMsg.content.substring(0, 10).replace(/\n/g, ' ');
            }
        } catch (e) {}

        // ç»Ÿä¸€ä½¿ç”¨AIç”Ÿæˆæ ‡é¢˜ï¼ˆå›¾åƒå¯¹è¯å’Œæ–‡æœ¬å¯¹è¯éƒ½ä½¿ç”¨ï¼‰
        const context = conversation.slice(0, 2).map(m => {
            // å¦‚æœæ˜¯å›¾åƒURLï¼Œæ›¿æ¢ä¸ºæè¿°
            const content = (m.content && (m.content.startsWith('http://') || m.content.startsWith('https://'))) 
                ? '[å›¾åƒ]' 
                : m.content;
            return `${m.role}: ${content}`;
        }).join('\n');
        const prompt = `è¯·é˜…è¯»ä»¥ä¸‹å¯¹è¯ï¼Œç”Ÿæˆä¸€ä¸ªæå…¶ç®€çŸ­çš„æ ‡é¢˜ï¼ˆä¸è¶…è¿‡10ä¸ªå­—ï¼‰ã€‚\nå¯¹è¯å†…å®¹ï¼š\n${context}`;

        try {
            // å›¾åƒå¯¹è¯ä½¿ç”¨ Qwen3 32Bï¼Œæ–‡æœ¬å¯¹è¯ä½¿ç”¨å½“å‰é€‰ä¸­çš„æ¨¡å‹
            const summaryModel = state.workflow === 'image' 
                ? TEXT_MODELS_MAP["Qwen3 32B"] || "Qwen/Qwen3-32B"
                : (TEXT_MODELS_MAP[state.textModelKey] || "deepseek-ai/DeepSeek-V3.2");

            let res = await fetch(`${API_BASE}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({
                    model: summaryModel, 
                    messages: [{ role: "user", content: prompt }],
                    stream: false,
                    enable_thinking: false
                })
            });
            
            if (res.ok) {
                const data = await res.json();
                let aiTitle = data.choices?.[0]?.message?.content?.trim();
                if (aiTitle) finalTitle = aiTitle.replace(/["ã€Šã€‹]/g, '');
            }
            
            // æ›´æ–°åç«¯æ ‡é¢˜
            await fetch(`${BACKEND_URL}/chat/${chatId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ title: finalTitle })
            });
            
            // åˆ·æ–°ä¾§è¾¹æ 
            loadChatList();
        } catch (e) { 
            console.error("æ ‡é¢˜ç”Ÿæˆå¤±è´¥", e); 
        }
    }

    // === æ–°å¢ï¼šåœæ­¢ç”Ÿæˆé€»è¾‘ ===
    function stopGeneration() {
        if (abortController) {
            abortController.abort(); // 1. ä¸­æ–­ç½‘ç»œè¯·æ±‚
            abortController = null;
        }
        const wasImageJob = processingWorkflow === 'image';
        const wasTextJob = processingWorkflow === 'text';
        isChatProcessing = false;
        processingWorkflow = null;
        if (wasImageJob) {
            imageGenerationContext = null;
        }
        if (wasTextJob) {
            textGenerationContext = null;
        }
        
        // 2. ç•Œé¢æ¢å¤
        updateInputUI(false);
        
        // 3. ç»™å¯¹è¯æ¡†æœ€åè¿½åŠ ä¸€ä¸ª [å·²åœæ­¢] çš„æç¤º (å¯é€‰)
        const container = document.getElementById('chat-container');
        if (container) {
            const loadingDiv = container.querySelector('#loading-text')?.closest('.flex');
            if (loadingDiv) loadingDiv.remove();
            
            const bubbles = container.querySelectorAll('.markdown-body');
            if(bubbles.length > 0 && state.messages.length > 0) {
                const lastMsg = state.messages[state.messages.length - 1];
                // åªæœ‰å½“æœ€åä¸€æ¡æ˜¯ AI å‘çš„æ¶ˆæ¯æ—¶æ‰è¿½åŠ 
                if (lastMsg.role === 'assistant' && lastMsg.content) {
                    const lastBubble = bubbles[bubbles.length - 1];
                    lastBubble.insertAdjacentHTML('beforeend', '<span class="text-xs text-red-400 ml-2 select-none"> (å·²æ‰‹åŠ¨åœæ­¢)</span>');
                }
            }
        }
    }

    // === 6. æ¸²æŸ“ä¸å‘é€ ===
    function renderChatHistory() {
        const container = document.getElementById('chat-container');
        if (state.messages.length === 0) {
            container.innerHTML = `
            <div class="flex flex-col items-center justify-center mt-20 space-y-4 px-4">
                <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mb-2">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-gray-800">Hiï¼ŒåŒå­¦ä½ å¥½ï¼æˆ‘æ˜¯æœªæ¹ƒ WAPI æ™ºèƒ½å¯¼å¸ˆ</h3>
                <p class="text-sm text-gray-500 text-center max-w-md leading-relaxed">
                    æ— è®ºä½ æƒ³åœ¨è¿™ä¸ªèˆå°ä¸Š<span class="text-blue-600 font-bold">è‡ªä¿¡æ¼”è®²</span>ï¼Œ<br>
                    è¿˜æ˜¯æƒ³ç”¨ AI åˆ›é€ ä¸€éƒ¨<span class="text-purple-600 font-bold">å±äºä½ çš„ç”µå½±</span>ï¼Œ<br>
                    æˆ‘éƒ½éšæ—¶å‡†å¤‡å¥½ä¸ºä½ æä¾›çµæ„Ÿï¼
                </p>
                <div class="flex gap-2 mt-4">
                    <button onclick="document.getElementById('chat-input').value='å¸®æˆ‘æŠŠè¿™ç¯‡æ¼”è®²ç¨¿æ¶¦è‰²å¾—æ›´æœ‰æ°”åŠ¿ä¸€ç‚¹';document.getElementById('chat-input').focus();" class="text-xs bg-white border border-gray-200 px-3 py-1.5 rounded-full text-gray-600 hover:border-blue-400 hover:text-blue-600 transition-colors">ğŸ¤ æ¶¦è‰²æ¼”è®²ç¨¿</button>
                    <button onclick="document.getElementById('chat-input').value='æˆ‘æƒ³åšä¸€ä¸ªèµ›åšæœ‹å…‹é£æ ¼çš„å¾®ç”µå½±ï¼Œç»™æˆ‘ä¸€äº›åˆ†é•œçµæ„Ÿ';document.getElementById('chat-input').focus();" class="text-xs bg-white border border-gray-200 px-3 py-1.5 rounded-full text-gray-600 hover:border-purple-400 hover:text-purple-600 transition-colors">ğŸ¬ ç”µå½±åˆ†é•œçµæ„Ÿ</button>
                </div>
            </div>
        `;
            return;
        }
        
        container.innerHTML = state.messages.map(msg => {
            const isUser = msg.role === 'user';
            
            // æ£€æµ‹æ˜¯å¦æ˜¯å›¾åƒæ¶ˆæ¯ï¼ˆURLæ ¼å¼ï¼‰
            const isImageUrl = !isUser && (msg.content.startsWith('http://') || msg.content.startsWith('https://') || msg.content.match(/\.(jpg|jpeg|png|gif|webp)$/i));
            
            // âœ… ä¿®æ”¹é‡ç‚¹ï¼šæ¶ˆæ¯æ°”æ³¡çš„äº®è‰²æ ·å¼
            // User: è“è‰²æ·¡èƒŒæ™¯ï¼Œè“è‰²æ–‡å­—
            // AI: ç™½è‰²èƒŒæ™¯ï¼Œç™½è‰²é˜´å½±ï¼Œæ·±è‰²æ–‡å­—ï¼ˆæˆ–å›¾åƒï¼‰
            let contentHtml = '';
            if (isImageUrl) {
                // å›¾åƒæ¶ˆæ¯ - è¿›ä¸€æ­¥å‹ç¼©å›¾åƒæ˜¾ç¤ºå°ºå¯¸ï¼Œé™åˆ¶æœ€å¤§é«˜åº¦ä¸º300px
                const imageUrlAttr = (msg.content || '').replace(/"/g, '&quot;');
                contentHtml = `
                    <div class="w-full space-y-3">
                        <img src="${msg.content}" alt="ç”Ÿæˆçš„å›¾åƒ" class="w-full max-w-full h-auto rounded-lg shadow-md" style="max-width: 100%; max-height: 300px; width: auto; height: auto; object-fit: contain;" onerror="this.parentElement.innerHTML='<p class=\\'text-red-500 text-sm\\'>å›¾åƒåŠ è½½å¤±è´¥</p>'">
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button type="button" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl border border-gray-200 bg-white/80 text-xs font-bold text-gray-700 shadow-sm hover:bg-blue-600 hover:text-white hover:border-blue-500 hover:shadow-lg transition-all group" data-url="${imageUrlAttr}" onclick="downloadImageFromChat(this)">
                                <svg class="w-4 h-4 text-gray-500 transition-colors group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                ä¸‹è½½åŸå›¾
                            </button>
                            <button type="button" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl border border-gray-200 bg-white/80 text-xs font-bold text-gray-700 shadow-sm hover:bg-blue-600 hover:text-white hover:border-blue-500 hover:shadow-lg transition-all group" data-url="${imageUrlAttr}" onclick="openImageDetailFromChat(this)">
                                <svg class="w-4 h-4 text-gray-500 transition-colors group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                æ‰“å¼€è¯¦æƒ…é¡µ
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // æ–‡æœ¬æ¶ˆæ¯
                contentHtml = isUser ? msg.content : marked.parse(msg.content);
            }
            
            return `
                <div class="flex ${isUser ? 'flex-row-reverse' : 'flex-row'} items-start gap-2 msg-animate">
                    <div class="flex-1 min-w-0 flex ${isUser ? 'justify-end' : 'justify-start'}">
                            <div class="markdown-body ${isUser ? 'bg-blue-50/50 border-blue-100 text-gray-800' : 'bg-white border-gray-100 shadow-sm text-gray-800'} border px-5 py-3.5 rounded-2xl ${isUser ? 'rounded-tr-sm' : 'rounded-tl-sm'} text-sm leading-relaxed ${!isUser ? 'max-w-[50%]' : ''}">${contentHtml}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.scrollTop = container.scrollHeight;
    }

    async function sendTextMessage() {
        // ã€é€»è¾‘åˆ†æ”¯ 1ã€‘å¦‚æœæ­£åœ¨ç”Ÿæˆï¼Œç‚¹å‡»æŒ‰é’®åˆ™è§†ä¸º"åœæ­¢"
        if (isChatProcessing) {
            stopGeneration();
            return;
        }

        if (state.workflow === 'image' && imageGenerationContext && imageGenerationContext.chatId && imageGenerationContext.chatId !== state.chatHistoryId) {
            alert("å½“å‰ä»æœ‰å…¶ä»–å›¾ç‰‡ç”Ÿæˆä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™å®Œæˆåå†å¼€å§‹æ–°çš„ç”Ÿæˆã€‚");
            return;
        }

        if (state.workflow === 'text' && textGenerationContext && (textGenerationContext.chatId ? textGenerationContext.chatId !== state.chatHistoryId : true)) {
            alert("å½“å‰ä»æœ‰å…¶ä»–æ–‡æœ¬å¯¹è¯åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™å®Œæˆåå†å¼€å§‹æ–°çš„ç”Ÿæˆã€‚");
            return;
        }

        const input = document.getElementById('chat-input');
        const prompt = input.value.trim();
        if (!prompt && !uploadedDocument) {
            alert('è¯·è¾“å…¥å†…å®¹æˆ–ä¸Šä¼ æ–‡æ¡£');
            return;
        }

        abortController = new AbortController(); // åˆ›å»ºæ–°æ§åˆ¶å™¨
        const activeController = abortController;
        isChatProcessing = true;
        processingWorkflow = state.workflow;
        updateInputUI(true); // åˆ‡æ¢ä¸º"åœæ­¢"çŠ¶æ€

        if (processingWorkflow === 'image') {
            imageGenerationContext = {
                chatId: state.chatHistoryId,
                controller: activeController,
                isBackground: false
            };
        } else if (processingWorkflow === 'text') {
            textGenerationContext = {
                chatId: state.chatHistoryId,
                controller: activeController,
                isBackground: false,
                messagesRef: state.messages
            };
        }

        // åªæœ‰åœ¨æ²¡æœ‰ä¸Šä¼ æ–‡æ¡£æ—¶æ‰ç›´æ¥æ·»åŠ çº¯æ–‡æœ¬æ¶ˆæ¯
        // å¦‚æœæœ‰æ–‡æ¡£ï¼Œæ¶ˆæ¯å°†åœ¨æ–‡æ¡£å¤„ç†åˆ†æ”¯ä¸­ç»Ÿä¸€æ·»åŠ 
        if (!uploadedDocument) {
            state.messages.push({ role: "user", content: prompt });
            renderChatHistory();
        }
        
        input.value = '';
        input.style.height = 'auto';
        
        let ensuredChatId = null;
        if (!uploadedDocument) {
            ensuredChatId = await saveMessageToBackend("user", prompt);
        } 

        // è¿™éƒ¨åˆ†é€»è¾‘éœ€è¦åœ¨æ–‡æ¡£å¤„ç†å®Œæˆåæ›´æ–°ï¼Œç§»åˆ°æ–‡æ¡£å¤„ç†åˆ†æ”¯ä¸­

        const container = document.getElementById('chat-container');
        
        // æ ¹æ®å·¥ä½œæµç±»å‹å†³å®šå¤„ç†æ–¹å¼
        if (state.workflow === 'image') {
            // å›¾åƒç”Ÿæˆæµç¨‹
            // è®°å½•ç”Ÿæˆå¼€å§‹æ—¶çš„å¯¹è¯IDï¼Œç”¨äºåç»­æ£€æŸ¥
            const generatingChatId = state.chatHistoryId;
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex flex-row items-start gap-2";
            loadingDiv.innerHTML = `<div class="flex-1 min-w-0 flex justify-start"><div class="bg-white border border-gray-100 px-5 py-3.5 rounded-2xl rounded-tl-sm text-sm shadow-sm max-w-[50%]"><span class="animate-pulse text-gray-500" id="loading-text">æ­£åœ¨ç”Ÿæˆå›¾åƒ...</span></div></div>`;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;

            try {
                const resolution = document.getElementById('resolution-select').value;
                const aspectRatio = document.getElementById('aspect-ratio-select').value;
                
                const res = await fetch(`${API_BASE}/images/generations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ 
                        model: IMAGE_MODELS_MAP[state.imageModelKey] || "Kwai-Kolors/Kolors", 
                        prompt: prompt, 
                        size: resolution,
                        style: "none" // ä¸å†ä½¿ç”¨é£æ ¼é¢„è®¾
                    }),
                    signal: activeController.signal
                });
                
                if (!res.ok) throw new Error(await res.text());
                const result = await res.json();
                const data = result.data || {};
                
                // æ£€æŸ¥ç”Ÿæˆå®Œæˆæ—¶æ˜¯å¦è¿˜åœ¨åŒä¸€ä¸ªå¯¹è¯ä¸­
                if (state.chatHistoryId !== generatingChatId) {
                    // å·²ç»åˆ‡æ¢åˆ°å…¶ä»–å¯¹è¯ï¼Œä¸æ›´æ–°å½“å‰UIï¼Œåªä¿å­˜åˆ°åç«¯
                    console.log("å›¾åƒç”Ÿæˆå®Œæˆï¼Œä½†å·²åˆ‡æ¢åˆ°å…¶ä»–å¯¹è¯ï¼Œé™é»˜ä¿å­˜åˆ°åŸå¯¹è¯");
                    
                    // æ˜¾ç¤ºé€šçŸ¥æç¤ºç”¨æˆ·å›¾ç‰‡å·²ç”Ÿæˆ
                    showNotification('å›¾ç‰‡ç”Ÿæˆå®Œæˆ', 'å›¾ç‰‡å·²ä¿å­˜åˆ°åŸå¯¹è¯ä¸­ï¼Œç‚¹å‡»æŸ¥çœ‹', () => {
                        loadChatDetail(generatingChatId);
                    });
                    
                    // ç›´æ¥ä¿å­˜æ¶ˆæ¯åˆ°ç”Ÿæˆæ—¶çš„å¯¹è¯
                    try {
                        await saveMessageToBackend("assistant", data.url, generatingChatId);
                        await loadChatList();
                        
                        // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆæ ‡é¢˜ï¼ˆéœ€è¦å…ˆè·å–å¯¹è¯æ¶ˆæ¯æ•°é‡ï¼‰
                        const chatRes = await fetch(`${BACKEND_URL}/chat/${generatingChatId}`, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        if (chatRes.ok) {
                            const chat = await chatRes.json();
                            const messages = chat.messages || [];
                            if (messages.length === 2) {
                                generateSmartTitle(generatingChatId, messages);
                            }
                        }
                    } catch (e) {
                        console.error("ä¿å­˜åˆ°åŸå¯¹è¯å¤±è´¥:", e);
                    }
                } else {
                    // è¿˜åœ¨åŒä¸€ä¸ªå¯¹è¯ä¸­ï¼Œæ­£å¸¸æ›´æ–°UI
                    if(loadingDiv && loadingDiv.parentNode) loadingDiv.remove();
                    
                    state.messages.push({ role: "assistant", content: data.url });
                    renderChatHistory();
                    await saveMessageToBackend("assistant", data.url, generatingChatId);
                    
                    if (state.messages.length === 2 && generatingChatId) {
                        generateSmartTitle(generatingChatId, state.messages);
                    }
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log("ç”¨æˆ·æ‰‹åŠ¨åœæ­¢ç”Ÿæˆ");
                    // åªæœ‰åœ¨åŒä¸€ä¸ªå¯¹è¯ä¸­æ‰ä¿å­˜åœæ­¢çŠ¶æ€
                    if (state.chatHistoryId === generatingChatId && state.messages[state.messages.length-1].content) {
                       await saveMessageToBackend("assistant", state.messages[state.messages.length-1].content, generatingChatId);
                    }
                } else {
                    console.error(error);
                    // åªæœ‰åœ¨åŒä¸€ä¸ªå¯¹è¯ä¸­æ‰æ˜¾ç¤ºé”™è¯¯
                    if (state.chatHistoryId === generatingChatId) {
                        if(loadingDiv && loadingDiv.parentNode) loadingDiv.remove();
                        state.messages.push({ role: "assistant", content: "âŒ å‡ºé”™: " + error.message });
                        renderChatHistory();
                    }
                }
            } finally {
                // æ— è®ºåœ¨å“ªä¸ªå¯¹è¯ï¼Œéƒ½è¦é‡ç½®UIçŠ¶æ€
                isChatProcessing = false;
                if (abortController === activeController) {
                    abortController = null;
                }
                if (imageGenerationContext && imageGenerationContext.chatId === generatingChatId) {
                    imageGenerationContext = null;
                }
                processingWorkflow = null;
                
                // åªæœ‰åœ¨åŒä¸€ä¸ªå¯¹è¯ä¸­æ‰ç§»é™¤loading
                if (state.chatHistoryId === generatingChatId) {
                    if (loadingDiv && loadingDiv.parentNode) loadingDiv.remove();
                }
                
                // é‡è¦ï¼šæ¢å¤UIçŠ¶æ€ï¼ˆæ— è®ºæ˜¯å¦åˆ‡æ¢å¯¹è¯ï¼‰
                updateInputUI(false);
            }
            return;
        } else if (uploadedDocument) {
            // å¸¦æ–‡æ¡£çš„æ–‡æœ¬å·¥ä½œæµ
            const generatingChatId = state.chatHistoryId;
            const userContent = `ğŸ“„ å·²ä¸Šä¼ æ–‡æ¡£: ${uploadedDocument.fileName}${prompt ? `\n\n${prompt}` : ''}`;
            state.messages.push({ role: "user", content: userContent });
            renderChatHistory();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex flex-row items-start gap-2";
            loadingDiv.innerHTML = `<div class="flex-1 min-w-0 flex justify-start"><div class="bg-white border border-gray-100 px-5 py-3.5 rounded-2xl rounded-tl-sm text-sm shadow-sm max-w-[50%]"><span class="animate-pulse text-gray-500" id="loading-text">æ­£åœ¨åˆ†ææ–‡æ¡£...</span></div></div>`;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;

            try {
                const response = await fetch(`${API_BASE}/chat/with-document`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({
                        prompt: prompt || 'è¯·åˆ†æè¿™ä»½æ–‡æ¡£'
                    }),
                    signal: activeController.signal
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'æ–‡æ¡£åˆ†æå¤±è´¥');
                }

                const result = await response.json();
                
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                if (loadingDiv && loadingDiv.parentNode) loadingDiv.remove();

                // æ·»åŠ  AI å›å¤
                state.messages.push({ role: "assistant", content: result.data.analysis });
                renderChatHistory();
                
                // ä¿å­˜åˆ°åç«¯
                ensuredChatId = await saveMessageToBackend("user", userContent);
                await saveMessageToBackend("assistant", result.data.analysis);
                
                // è®¾ç½®æ–‡æ¡£å¤„ç†åˆ†æ”¯çš„ chatId
                if (textGenerationContext && !textGenerationContext.chatId) {
                    textGenerationContext.chatId = ensuredChatId || state.chatHistoryId;
                }

                // æ¸…é™¤å·²ä¸Šä¼ æ–‡æ¡£
                clearUploadedDocument();

                // ç”Ÿæˆæ ‡é¢˜
                if (state.messages.length === 2) {
                    generateSmartTitle(state.chatHistoryId, state.messages);
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log("ç”¨æˆ·æ‰‹åŠ¨åœæ­¢ç”Ÿæˆ");
                } else {
                    console.error('æ–‡æ¡£åˆ†æå¤±è´¥:', error);
                    if (loadingDiv && loadingDiv.parentNode) {
                        loadingDiv.remove();
                    }
                    alert(`æ–‡æ¡£åˆ†æå¤±è´¥: ${error.message}`);
                }
            } finally {
                if (abortController === activeController) {
                    abortController = null;
                }
                isChatProcessing = false;
                processingWorkflow = null;
                textGenerationContext = null;
                updateInputUI(false);
            }
            return;
        }

        // æ–‡æœ¬å¯¹è¯æµç¨‹
        const targetChatId = textGenerationContext?.chatId || state.chatHistoryId;
        const targetMessages = state.messages;
        const loadingDiv = document.createElement('div');
        loadingDiv.className = "flex flex-row items-start gap-2";
        loadingDiv.innerHTML = `<div class="flex-1 min-w-0 flex justify-start"><div class="bg-white border border-gray-100 px-5 py-3.5 rounded-2xl rounded-tl-sm text-sm shadow-sm max-w-[50%]"><span class="animate-pulse text-gray-500" id="loading-text">Thinking...</span></div></div>`;
        container.appendChild(loadingDiv);
        container.scrollTop = container.scrollHeight;

        const shouldDisplayInCurrentChat = () => {
            if (!targetChatId) return false;
            const isBackground = textGenerationContext && textGenerationContext.chatId === targetChatId && textGenerationContext.isBackground;
            return state.chatHistoryId === targetChatId && !isBackground;
        };

        let assistantMessage = null;
        
        // ä¸ºçº¯æ–‡æœ¬å¤„ç†åˆ†æ”¯è®¾ç½® chatId
        if (textGenerationContext && !textGenerationContext.chatId && ensuredChatId) {
            textGenerationContext.chatId = ensuredChatId;
        }

        try {
            const context = targetMessages.map(m=>({role:m.role, content:m.content})).slice(-10);
            const finalMessages = [
                { role: "system", content: SYSTEM_PROMPT },
                ...context
            ];

            const payload = { 
                model: TEXT_MODELS_MAP[state.textModelKey], 
                messages: finalMessages,
                stream: true, 
                enable_thinking: false 
            };
            
            let res = await fetch(`${API_BASE}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify(payload),
                signal: activeController.signal 
            });

            if (res.status === 429) {
                await new Promise(resolve => setTimeout(resolve, 3000));
                res = await fetch(`${API_BASE}/chat/completions`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, 
                    body: JSON.stringify(payload),
                    signal: activeController.signal 
                });
            }
            if (!res.ok) throw new Error(`æœåŠ¡è¯·æ±‚å¤±è´¥: ${res.status}`);

            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");
            if(loadingDiv && loadingDiv.parentNode) loadingDiv.remove();
            
            assistantMessage = { role: "assistant", content: "" };
            targetMessages.push(assistantMessage);
            let lastBubble = null;

            const ensureBubble = () => {
                if (!shouldDisplayInCurrentChat()) {
                    lastBubble = null;
                    return;
                }
                if (!lastBubble || !lastBubble.isConnected) {
                    renderChatHistory();
                    const bubbles = container.querySelectorAll('.markdown-body');
                    lastBubble = bubbles[bubbles.length - 1] || null;
                }
            };
            ensureBubble();
            
            let fullResponse = "";
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const lines = decoder.decode(value, { stream: true }).split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        try {
                            const content = JSON.parse(line.substring(6)).choices[0]?.delta?.content || "";
                            fullResponse += content;
                            assistantMessage.content = fullResponse;
                            if (shouldDisplayInCurrentChat()) {
                                ensureBubble();
                                if (lastBubble) {
                                    lastBubble.innerHTML = marked.parse(fullResponse || " ");
                                    container.scrollTop = container.scrollHeight;
                                }
                            }
                        } catch (e) {}
                    }
                }
            }

            if (assistantMessage && !assistantMessage.content && fullResponse.trim()) {
                assistantMessage.content = fullResponse;
            }
            if (assistantMessage && assistantMessage.content.trim()) {
                await saveMessageToBackend("assistant", assistantMessage.content, targetChatId);
            } else if (assistantMessage && !assistantMessage.content.trim()) {
                // å¦‚æœå†…å®¹ä¸ºç©ºæˆ–åªæœ‰ç©ºæ ¼ï¼Œä»æ¶ˆæ¯æ•°ç»„ä¸­ç§»é™¤è¿™ä¸ªç©ºæ¶ˆæ¯
                const index = targetMessages.indexOf(assistantMessage);
                if (index > -1) {
                    targetMessages.splice(index, 1);
                }
            }

            const finishedInCurrentChat = shouldDisplayInCurrentChat();
            
            // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œç¡®ä¿ä¸æ˜¾ç¤ºç©ºæ°”æ³¡
            if (assistantMessage && !assistantMessage.content.trim()) {
                const index = targetMessages.indexOf(assistantMessage);
                if (index > -1) {
                    targetMessages.splice(index, 1);
                }
                if (finishedInCurrentChat) {
                    renderChatHistory();
                }
            }
            
            if (!finishedInCurrentChat) {
                await loadChatList();
            }

            if (finishedInCurrentChat && targetMessages.length === 2 && targetChatId) {
                generateSmartTitle(targetChatId, targetMessages);
            } else if (targetChatId && !finishedInCurrentChat) {
                showNotification('æ–‡å­—ç”Ÿæˆå®Œæˆ', 'æ–‡å­—ç»“æœå·²å†™å›åŸå¯¹è¯ï¼Œç‚¹å‡»æŸ¥çœ‹', () => {
                    loadChatDetail(targetChatId);
                });
            }

        } catch (error) {
            if (error.name === 'AbortError') {
                console.log("ç”¨æˆ·æ‰‹åŠ¨åœæ­¢ç”Ÿæˆ");
                if( assistantMessage && assistantMessage.content) {
                   await saveMessageToBackend("assistant", assistantMessage.content, targetChatId);
                }
            } else {
                console.error(error);
                if(loadingDiv && loadingDiv.parentNode) loadingDiv.remove();
                if (shouldDisplayInCurrentChat()) {
                    targetMessages.push({ role: "assistant", content: "âŒ å‡ºé”™: " + error.message });
                    renderChatHistory();
                } else if (targetChatId) {
                    showNotification('æ–‡å­—ç”Ÿæˆå¤±è´¥', 'åŸå¯¹è¯å‘ç”Ÿé”™è¯¯ï¼Œç‚¹å‡»å¯é‡æ–°æŸ¥çœ‹', () => {
                        loadChatDetail(targetChatId);
                    });
                }
            }
        } finally {
            if (loadingDiv && loadingDiv.parentNode) loadingDiv.remove();
            isChatProcessing = false;
            if (abortController === activeController) {
                abortController = null;
            }
            processingWorkflow = null;
            if (textGenerationContext && textGenerationContext.controller === activeController) {
                textGenerationContext = null;
            }
            updateInputUI(false);
        }
    }

    // === è®¤è¯ ===
    function checkLoginState() {
        const modal = document.getElementById('auth-modal');
        if (authToken) {
            modal.classList.add('hidden');
            // document.getElementById('user-info-display').classList.remove('hidden'); // âŒ è¿™ä¸€è¡Œåˆ æ‰ï¼Œå› ä¸ºä¾§è¾¹æ ç”¨æˆ·ä¿¡æ¯åŒºæ²¡äº†
            try {
                const u = JSON.parse(localStorage.getItem('wapi_user'));
                if(u) {
                    // âœ… ä¿®æ”¹ä¸ºï¼šæ›´æ–°é¡¶éƒ¨ Header çš„ç”¨æˆ·å
                    const headerNameEl = document.getElementById('header-username');
                    if(headerNameEl) headerNameEl.innerText = u.username;
                }
                loadChatList();
            } catch(e){}
        } else {
            modal.classList.remove('hidden');
            // document.getElementById('user-info-display').classList.add('hidden'); // âŒ è¿™ä¸€è¡Œåˆ æ‰
        }
    }

    // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ¨¡å¼
    let isRegisterMode = false;
    function toggleAuthMode() {
        const regCodeInput = document.getElementById('auth-registration-code');
        const loginBtn = document.getElementById('btn-login');
        const registerBtn = document.getElementById('btn-register');
        const backBtn = document.getElementById('btn-back-login');
        
        isRegisterMode = !isRegisterMode;
        
        if (isRegisterMode) {
            regCodeInput.classList.remove('hidden');
            loginBtn.classList.add('hidden');
            registerBtn.classList.remove('hidden');
            registerBtn.textContent = 'ç¡®è®¤æ³¨å†Œ';
            if (backBtn) backBtn.classList.remove('hidden');
        } else {
            regCodeInput.classList.add('hidden');
            loginBtn.classList.remove('hidden');
            registerBtn.classList.remove('hidden');
            registerBtn.textContent = 'æ³¨å†Œæ–°è´¦å·';
            if (backBtn) backBtn.classList.add('hidden');
        }
    }

    // ç»‘å®šç™»å½•å’Œæ³¨å†ŒæŒ‰é’®äº‹ä»¶ï¼ˆåœ¨é¡µé¢åŠ è½½æ—¶æ‰§è¡Œï¼‰
    function bindAuthButtons() {
        // ç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const loginBtn = document.getElementById('btn-login');
        if (loginBtn) {
            loginBtn.addEventListener('click', function() {
                handleAuth('login');
            });
        }

        // æ³¨å†ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const registerBtn = document.getElementById('btn-register');
        if (registerBtn) {
            registerBtn.addEventListener('click', function(e) {
                if (!isRegisterMode) {
                    e.preventDefault();
                    toggleAuthMode();
                } else {
                    handleAuth('register');
                }
            });
        }

        const backBtn = document.getElementById('btn-back-login');
        if (backBtn) {
            backBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (isRegisterMode) {
                    toggleAuthMode();
                }
            });
        }
    }

    async function handleAuth(type) {
        const u = document.getElementById('auth-username').value.trim();
        const p = document.getElementById('auth-password').value.trim();
        const regCode = document.getElementById('auth-registration-code').value.trim();
        const errBox = document.getElementById('auth-error');
        
        if (!u || !p) return errBox.innerText = "è¯·è¾“å…¥è´¦å·å¯†ç ", errBox.classList.remove('hidden');
        if (type === 'register' && !regCode) return errBox.innerText = "è¯·è¾“å…¥æ³¨å†Œç ", errBox.classList.remove('hidden');

        try {
            const body = { username: u, password: p };
            if (type === 'register') {
                body.registrationCode = regCode;
            }
            
            const res = await fetch(`${BACKEND_URL}/auth/${type}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const result = await res.json();
            if (!res.ok || !result.success) throw new Error(result.message || 'è¯·æ±‚å¤±è´¥');

            if (type === 'register') {
                alert("æ³¨å†ŒæˆåŠŸ");
                // åˆ‡æ¢å›ç™»å½•æ¨¡å¼
                toggleAuthMode();
                // æ¸…ç©ºæ³¨å†Œç è¾“å…¥æ¡†
                document.getElementById('auth-registration-code').value = '';
            } else {
                // ä½¿ç”¨æ–°çš„å“åº”æ ¼å¼
                authToken = result.data.token;
                localStorage.setItem('wapi_token', authToken);
                localStorage.setItem('wapi_user', JSON.stringify(result.data.user));
                checkLoginState();
            }
            errBox.classList.add('hidden');
        } catch (e) {
            errBox.innerText = e.message;
            errBox.classList.remove('hidden');
        }
    }

    // === æ¨¡å‹é€‰æ‹©å™¨é€»è¾‘ (æ•´åˆç‰ˆ) ===
    function toggleModelMenu(e) {
        if(e) e.stopPropagation();
        const menu = document.getElementById('model-dropdown');
        if (menu.classList.contains('invisible')) {
            renderModelListInInput(); 
            menu.classList.remove('invisible', 'opacity-0', 'translate-y-2');
        } else {
            menu.classList.add('invisible', 'opacity-0', 'translate-y-2');
        }
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
    document.addEventListener('click', (e) => {
        const menu = document.getElementById('model-dropdown');
        if (menu && !menu.contains(e.target) && !e.target.closest('[onclick*="toggleModelMenu"]')) {
            menu.classList.add('invisible', 'opacity-0', 'translate-y-2');
        }
    });

    function renderModelListInInput() {
        const container = document.getElementById('model-list-container');
        const currentKey = state.workflow === 'text' ? state.textModelKey : state.imageModelKey;

        // ç”Ÿæˆåˆ†ç»„åˆ—è¡¨ï¼šå…ˆæ˜¾ç¤ºæ–‡æœ¬æ¨¡å‹ï¼Œå†æ˜¾ç¤ºè§†è§‰æ¨¡å‹
        let html = '';
        
        // 1. æ–‡æœ¬æ¨¡å‹ç»„ - æµ…é»„è‰²åº•è‰²
        html += `<div class="px-3 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider bg-yellow-50 border-y border-yellow-100">æ™ºèƒ½å¯¹è¯æ¨¡å‹</div>`;
        Object.keys(TEXT_MODELS_MAP).forEach(key => {
            const isSelected = state.workflow==='text' && key === currentKey;
             html += `
                <div onclick="selectModelFromInput('text', '${key}')" class="mx-2 my-1 px-3 py-2 cursor-pointer flex items-center justify-between group transition-all ${isSelected ? 'bg-blue-500 text-white rounded-lg' : 'hover:bg-yellow-100 rounded-lg'}">
                    <span class="text-xs font-medium ${isSelected ? 'text-white font-bold' : 'text-gray-700'}">${key}</span>
                    ${isSelected ? '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : ''}
                </div>`;
        });

        // 2. è§†è§‰æ¨¡å‹ç»„ - æµ…è“è‰²åº•è‰²
        html += `<div class="px-3 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider bg-blue-50 border-y border-blue-100 mt-1">è§†è§‰ç”Ÿæˆæ¨¡å‹</div>`;
        Object.keys(IMAGE_MODELS_MAP).forEach(key => {
            const isSelected = state.workflow==='image' && key === currentKey;
             html += `
                <div onclick="selectModelFromInput('image', '${key}')" class="mx-2 my-1 px-3 py-2 cursor-pointer flex items-center justify-between group transition-all ${isSelected ? 'bg-blue-500 text-white rounded-lg' : 'hover:bg-blue-100 rounded-lg'}">
                    <span class="text-xs font-medium ${isSelected ? 'text-white font-bold' : 'text-gray-700'}">${key}</span>
                    ${isSelected ? '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : ''}
                </div>`;
        });

        container.innerHTML = html;
    }

    function selectModelFromInput(type, key) {
        const oldWorkflow = state.workflow;
        const oldTextModelKey = state.textModelKey;
        const oldImageModelKey = state.imageModelKey;
        
        // å¦‚æœä»è§†è§‰æ¨¡å‹åˆ‡æ¢åˆ°æ–‡æœ¬æ¨¡å‹ï¼Œéœ€è¦ç¡®è®¤
        if (oldWorkflow === 'image' && type === 'text') {
            if (!confirm("åˆ‡æ¢è¯­è¨€æ¨¡å‹åä¼šè¿›å…¥æ–°å¯¹è¯ï¼Œç¡®è®¤åˆ‡æ¢å—ï¼Ÿ")) {
                // ç”¨æˆ·å–æ¶ˆï¼Œæ¢å¤åŸæ¥çš„çŠ¶æ€
                return;
            }
            // ç”¨æˆ·ç¡®è®¤ï¼Œæ–°å»ºå¯¹è¯
            startNewChat(true);
        }
        // å¦‚æœåˆ‡æ¢åˆ°è§†è§‰æ¨¡å‹ï¼Œæ–°å»ºå¯¹è¯
        else if (type === 'image' && oldWorkflow === 'text') {
            startNewChat(true);
        }
        
        // æ›´æ–°çŠ¶æ€
        state.workflow = type;
        if (type === 'text') state.textModelKey = key;
        else state.imageModelKey = key;
        
        // æ›´æ–° UI
        const nameEl = document.getElementById('current-model-name');
        if(nameEl) nameEl.innerText = type === 'text' ? key : state.imageModelKey;
        
        // æ›´æ–°å·¥ä½œæµè§†å›¾
        updateWorkflowUI();
        
        // å…³é—­èœå•
        const menu = document.getElementById('model-dropdown');
        if(menu) menu.classList.add('invisible', 'opacity-0', 'translate-y-2');
    }

    // === é€šçŸ¥ç³»ç»Ÿ ===
    function showNotification(title, message, onClick = null) {
        // åˆ›å»ºé€šçŸ¥å®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        let container = document.getElementById('notification-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            container.className = 'fixed top-4 right-4 z-50 flex flex-col gap-2';
            document.body.appendChild(container);
        }

        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = 'bg-white border border-blue-200 rounded-lg shadow-lg p-4 min-w-[300px] max-w-[400px] transform transition-all duration-300 translate-x-full opacity-0';
        notification.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="flex-shrink-0">
                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="text-sm font-semibold text-gray-900">${title}</h3>
                    <p class="text-sm text-gray-600 mt-1">${message}</p>
                    ${onClick ? '<button class="mt-2 text-sm text-blue-600 hover:text-blue-700 font-medium" onclick="this.closest(\'.notification-item\').clickHandler()">ç‚¹å‡»æŸ¥çœ‹</button>' : ''}
                </div>
                <button class="flex-shrink-0 text-gray-400 hover:text-gray-600" onclick="this.closest('.notification-item').remove()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;
        notification.className += ' notification-item';
        
        // æ·»åŠ ç‚¹å‡»å¤„ç†å™¨
        if (onClick) {
            notification.clickHandler = () => {
                onClick();
                notification.remove();
            };
        }

        container.appendChild(notification);

        // åŠ¨ç”»æ˜¾ç¤º
        setTimeout(() => {
            notification.classList.remove('translate-x-full', 'opacity-0');
        }, 10);

        // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }

    function logout() {
        if (!confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) return; // å¢åŠ ç¡®è®¤æ‹¦æˆª
        
        localStorage.removeItem('wapi_token');
        localStorage.removeItem('wapi_user');
        location.reload();
    }

    function autoResizeTextarea(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }
    
    // ä¿®æ”¹ï¼šSidebar é€‰ä¸­çš„é«˜äº®é¢œè‰²
    function renderSidebar() {
        document.getElementById('text-model-list').innerHTML = Object.keys(TEXT_MODELS_MAP).map(key => `<div class="px-2 py-1 text-sm text-gray-500 cursor-pointer hover:text-gray-900 transition-colors ${state.textModelKey===key?'text-yellow-600 font-bold bg-yellow-50 rounded':''}" onclick="switchModel('text', '${key}')">${key}</div>`).join('');
        document.getElementById('image-model-list').innerHTML = Object.keys(IMAGE_MODELS_MAP).map(key => `<div class="px-2 py-1 text-sm text-gray-500 cursor-pointer hover:text-gray-900 transition-colors ${state.imageModelKey===key?'text-blue-600 font-bold bg-blue-50 rounded':''}" onclick="switchModel('image', '${key}')">${key}</div>`).join('');
    }
    function renderRatioOptions() {
        const aspectSelect = document.getElementById('aspect-ratio-select');
        const resSelect = document.getElementById('resolution-select');
        if (!aspectSelect || !resSelect) return;
        
        aspectSelect.innerHTML = Object.keys(ASPECT_RATIOS).map(k => `<option value="${k}">${k}</option>`).join('');
        aspectSelect.onchange = () => { 
            resSelect.innerHTML = ASPECT_RATIOS[aspectSelect.value].map(r => `<option value="${r}">${r}</option>`).join(''); 
        };
        aspectSelect.onchange(); // åˆå§‹åŒ–åˆ†è¾¨ç‡é€‰é¡¹
    }

    // === æ–°å¢ï¼šåˆ é™¤å¯¹è¯åŠŸèƒ½ ===
    async function deleteChat(event, chatId) {
        event.stopPropagation(); // é‡è¦ï¼šé˜»æ­¢ç‚¹å‡»äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è¯¯è§¦æ‰“å¼€å¯¹è¯
        
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡å¯¹è¯è®°å½•å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚")) return;

        try {
            const res = await fetch(`${BACKEND_URL}/chat/${chatId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            
            if (res.ok) {
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„å¯¹è¯ï¼Œåˆ™æ¸…ç©ºå½“å‰è§†å›¾
                if (state.chatHistoryId === chatId) {
                    startNewChat(true); 
                }
                // åˆ·æ–°åˆ—è¡¨
                loadChatList();
            } else {
                alert("åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
            }
        } catch (e) {
            console.error(e);
            alert("ç½‘ç»œé”™è¯¯");
        }
    }


    document.getElementById('send-btn').onclick = sendTextMessage;
    document.getElementById('chat-input').onkeydown = (e) => { 
        // ä¿®æ”¹ï¼šEnter é»˜è®¤ä¸ºæ¢è¡Œï¼Œåªæœ‰ Ctrl + Enter (æˆ– Command + Enter) æ‰å‘é€
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault(); 
            sendTextMessage(); 
        }
    };

    // === ç”»å»Šé€»è¾‘ (äº®è‰²é€‚é…) ===
    let currentGalleryImages = [];
    async function openImageGallery() {
        const modal = document.getElementById('gallery-modal');
        const grid = document.getElementById('gallery-grid');
        const emptyState = document.getElementById('gallery-empty');
        
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; 
        grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400 flex flex-col items-center gap-3"><svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>æ­£åœ¨åŠ è½½äº‘ç«¯èµ„äº§...</span></div>';
        emptyState.classList.add('hidden');

        try {
            const res = await fetch(`${API_BASE}/images/history`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            if (!res.ok) throw new Error("åŠ è½½å¤±è´¥");
            const result = await res.json();
            const images = result.data || [];
            currentGalleryImages = images;

            grid.innerHTML = ''; 
            if (images.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            // ä¿®æ”¹ï¼šç”»å»Šå¡ç‰‡èƒŒæ™¯æ”¹ä¸ºç™½è‰²ï¼Œå¢åŠ é˜´å½±
            images.forEach((img, index) => {
                const card = document.createElement('div');
                card.className = "group relative w-full aspect-square bg-white shadow-sm overflow-hidden cursor-pointer hover:shadow-md transition-all";
                card.onclick = () => showDetailModal(index);
                card.innerHTML = `
                    <img src="${img.imageUrl}" class="absolute inset-0 w-full h-full object-cover object-center transition-transform duration-500 group-hover:scale-105" loading="lazy" alt="Generated Art" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                    <div class="expired-layer hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-100 p-2 text-center select-none">
                         <svg class="w-8 h-8 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                         <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">å·²è¿‡æœŸ</span>
                    </div>
                    <div class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                         <svg class="w-6 h-6 text-white drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (e) { console.error(e); grid.innerHTML = `<div class="col-span-full text-center py-10 text-red-500">åŠ è½½å¤±è´¥: ${e.message}</div>`; }
    }

    async function ensureGalleryImagesLoaded(forceReload = false) {
        if (!forceReload && Array.isArray(currentGalleryImages) && currentGalleryImages.length > 0) {
            return currentGalleryImages;
        }
        const res = await fetch(`${API_BASE}/images/history`, { headers: { 'Authorization': `Bearer ${authToken}` } });
        if (!res.ok) throw new Error('åŠ è½½å›¾ç‰‡è®°å½•å¤±è´¥');
        const result = await res.json();
        currentGalleryImages = result.data || [];
        return currentGalleryImages;
    }

    async function openImageDetailFromChat(buttonEl) {
        const imageUrl = buttonEl?.dataset?.url;
        if (!imageUrl) return;

        try {
            await ensureGalleryImagesLoaded(false);
            let targetIndex = currentGalleryImages.findIndex(img => img.imageUrl === imageUrl);

            if (targetIndex === -1) {
                await ensureGalleryImagesLoaded(true);
                targetIndex = currentGalleryImages.findIndex(img => img.imageUrl === imageUrl);
            }

            if (targetIndex === -1) {
                alert("æœªèƒ½æ‰¾åˆ°å›¾ç‰‡è¯¦æƒ…ï¼Œå›¾ç‰‡å¯èƒ½å·²è¿‡æœŸï¼Œè¯·å‰å¾€ä½œå“åº“æŸ¥çœ‹ã€‚");
                window.open(imageUrl, '_blank');
                return;
            }

            showDetailModal(targetIndex);
        } catch (error) {
            console.error("æ‰“å¼€è¯¦æƒ…é¡µå¤±è´¥", error);
            alert("åŠ è½½å›¾ç‰‡è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        }
    }

    async function downloadImageFromChat(buttonEl) {
        const imageUrl = buttonEl?.dataset?.url;
        if (!imageUrl) return;

        const fallbackOpen = () => {
            try {
                window.open(imageUrl, '_blank');
            } catch (e) {
                console.error("æ— æ³•æ‰“å¼€æ–°çª—å£", e);
            }
        };

        try {
            const response = await fetch(imageUrl);
            if (!response.ok) throw new Error('ä¸‹è½½å¤±è´¥');
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = deriveImageFileNameFromUrl(imageUrl);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(blobUrl);
        } catch (error) {
            console.error("ä¸‹è½½åŸå›¾å¤±è´¥", error);
            fallbackOpen();
        }
    }

    function deriveImageFileNameFromUrl(imageUrl) {
        try {
            const { pathname } = new URL(imageUrl);
            const fileName = pathname.split('/').pop() || 'wapi-image';
            if (fileName.includes('.')) return fileName;
            return `${fileName}.png`;
        } catch (error) {
            const fallback = imageUrl.split('/').pop() || 'wapi-image.png';
            return fallback.includes('.') ? fallback : `${fallback}.png`;
        }
    }

    function showDetailModal(index) {
        const imgData = currentGalleryImages[index];
        if (!imgData) return;
        const modal = document.getElementById('detail-modal');
        const imgEl = document.getElementById('detail-img');
        imgEl.src = imgData.imageUrl;
        document.getElementById('detail-date').innerText = new Date(imgData.createdAt).toLocaleString();
        document.getElementById('detail-prompt').innerText = imgData.prompt;
        document.getElementById('detail-res').innerText = imgData.resolution || 'Unknown';
        document.getElementById('detail-model').innerText = imgData.model || 'Unknown';
        document.getElementById('detail-model').title = imgData.model || '';
        document.getElementById('detail-style').innerText = imgData.style || 'None';
        document.getElementById('detail-download').href = imgData.imageUrl;
        modal.classList.remove('hidden');
        setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
    }

    function closeDetailModal() {
        const modal = document.getElementById('detail-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => { modal.classList.add('hidden'); }, 300);
    }

    function copyPrompt() {
        navigator.clipboard.writeText(document.getElementById('detail-prompt').innerText).then(() => { alert("æç¤ºè¯å·²å¤åˆ¶ï¼"); });
    }

    // å…¨å±€çŠ¶æ€ï¼šå·²ä¸Šä¼ çš„æ–‡æ¡£ä¿¡æ¯
    let uploadedDocument = null;

    // === æ–‡æ¡£ä¸Šä¼ ä¸è§£æåŠŸèƒ½ ===
    async function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;

        if (file.size > 10 * 1024 * 1024) {
            alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
            input.value = '';
            return;
        }

        // æ˜¾ç¤ºæ­£åœ¨è§£æçŠ¶æ€
        const fileInfoEl = document.getElementById('uploaded-file-info');
        const statusTextEl = document.getElementById('upload-status-text');
        statusTextEl.textContent = 'æ­£åœ¨è§£æ...';
        fileInfoEl.classList.remove('hidden');

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch(`${API_BASE}/document/parse`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${authToken}` },
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'æ–‡æ¡£è§£æå¤±è´¥');
            }

            const result = await response.json();
            
            // ä¿å­˜å·²ä¸Šä¼ æ–‡æ¡£ä¿¡æ¯åˆ°å…¨å±€çŠ¶æ€
            uploadedDocument = {
                fileName: result.data.originalFileName,
                truncated: result.data.truncated
            };

            // æ›´æ–°UIæ˜¾ç¤ºä¸ºæˆåŠŸçŠ¶æ€
            statusTextEl.textContent = `å·²ä¸Šä¼  ${result.data.originalFileName}`;

        } catch (error) {
            console.error('æ–‡æ¡£ä¸Šä¼ å¤±è´¥:', error);
            alert(`æ–‡æ¡£ä¸Šä¼ å¤±è´¥: ${error.message}`);
            // å¤±è´¥æ—¶éšè—çŠ¶æ€
            fileInfoEl.classList.add('hidden');
        } finally {
            input.value = '';
        }
    }

    // æ¸…é™¤å·²ä¸Šä¼ æ–‡æ¡£
    function clearUploadedDocument() {
        uploadedDocument = null;
        const fileInfoEl = document.getElementById('uploaded-file-info');
        if (fileInfoEl) {
            fileInfoEl.classList.add('hidden');
        }
    }

    init();
    bindAuthButtons();

    window.addEventListener('load', () => {
        gsap.from("aside", { x: -50, opacity: 0, duration: 1, ease: "power3.out", delay: 0.2 });
        gsap.from("header", { y: -20, opacity: 0, duration: 0.8, ease: "power3.out", delay: 0.4 });
        gsap.from("main", { opacity: 0, duration: 1, delay: 0.5 });
    });
</script>
</body>
</html>